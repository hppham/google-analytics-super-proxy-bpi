<!DOCTYPE html>

<html>

<head>
  <title>LineChart</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      var twoDaysAgoUrl = 'https://gasuperproxybpi.appspot.com/query?id=ahFzfmdhc3VwZXJwcm94eWJwaXIVCxIIQXBpUXVlcnkYgICAgLqojgoM&format=json';
      var todayUrl = 'https://gasuperproxybpi.appspot.com/query?id=ahFzfmdhc3VwZXJwcm94eWJwaXIVCxIIQXBpUXVlcnkYgICAgICAgAoM&format=json';
      var oneDayAgoUrl = 'https://gasuperproxybpi.appspot.com/query?id=ahFzfmdhc3VwZXJwcm94eWJwaXIVCxIIQXBpUXVlcnkYgICAgNrjhgoM&format=json';
      var ajaxCallToday = $.ajax({
        url: todayUrl,
        type: 'GET',
        dataType: 'jsonp',
        data: {
          format: 'json'
        },
        error: function () {
          $('#info').html('<p>An error has occurred</p>');
        }
      });
      var ajaxCallOneDayAgo = $.ajax({
        url: oneDayAgoUrl,
        type: 'GET',
        dataType: 'jsonp',
        data: {
          format: 'json'
        },
        error: function () {
          $('#info').html('<p>An error has occurred</p>');
        }
      });
      var ajaxCallTwoDasyAgo = $.ajax({
        url: twoDaysAgoUrl,
        type: 'GET',
        dataType: 'jsonp',
        data: {
          format: 'json'
        },
        error: function () {
          $('#info').html('<p>An error has occurred</p>');
        }
      });


      $.when(ajaxCallToday, ajaxCallOneDayAgo, ajaxCallTwoDasyAgo).done(function (today, oneDayAgo, twoDaysAgo) {
        console.log('today: ', today);
        console.log('oneDayAgo: ', oneDayAgo);
        console.log('twoDaysAgo: ', twoDaysAgo);
        startGoogleChart(getRows(today[0].rows, oneDayAgo[0].rows.reverse(), twoDaysAgo[0].rows));
      });

      function getRows(todayRows, oneDayAgoRows, twoDaysAgoRows) {
        var rows = [];
        var currentDateTime = new Date($.now());
        var currentTime = currentDateTime.getHours() - 3;
        var counter = 0;
        if (currentTime > 0) { //only need today and oneDayAgo
          $.each(todayRows, function (index, value) {
            if (index > currentTime)
              return false;

            var datetime = convertToDateTime(value[0]);
            rows.push([datetime, parseInt(value[1]), value[1] + ' online students at ' + datetime + ' today']);
            counter++;
          });

          $.each(oneDayAgoRows, function (index, value) {
            if (counter >= 24)
              return false;

            var datetime = convertToDateTime(value[0]);
            rows.unshift([datetime, parseInt(value[1]), value[1] + ' online students at ' + datetime + ' yesterday']);
            counter++;
          });
        }

        console.log(rows);

        return rows;
      }

      function convertToDateTime(hours) {
        var suffix = (hours >= 12) ? 'pm' : 'am';
        var res = (hours > 12) ? hours - 12 : hours;
        res = (hours == 0) ? 12 : res;

        return res + suffix;
      }

      function startGoogleChart(rows) {
        google.charts.load('current', {
          'packages': ['corechart']
        });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
          var dataTable = new google.visualization.DataTable();
          dataTable.addColumn('string', 'hour');
          dataTable.addColumn('number', 'user');
          dataTable.addColumn({
            type: 'string',
            role: 'tooltip'
          });
          dataTable.addRows(rows);

          var options = {
            tooltip: {
              isHtml: true
            },
            legend: 'none',
            title: 'Number of Students Online',
            width: '100%',
            height: '100%',
            lineWidth: '1',
            pointSize: '10',
            curveType: 'function',
            vAxis: {
              format: 'decimal',
              gridlines: {
                count: 5
              }
            }
          };
          var chart = new google.visualization.LineChart(document.getElementById('vis_div'));
          chart.draw(dataTable, options);
        }
      }
    });
  </script>
</head>

<body style="font-family: Arial;border: 0 none;">
  <div id="info"></div>
  <div id="vis_div" style="width: 100%; height: 100%;"></div>
</body>

</html>